"use strict";(self.webpackChunkkpiece=self.webpackChunkkpiece||[]).push([[727],{727:(e,s,t)=>{t.r(s),t.d(s,{default:()=>l});var a=t(43),n=t(675),r=t(809),o=t(696),c=t(579);const l=()=>{const{tomelist:e,tomenumber:s,selectedpagetome:t}=(0,n.g)(),l=(0,n.Zp)(),[i,u]=(0,a.useState)([]),[d,m]=(0,a.useState)([]),[h,f]=(0,a.useState)(!0),[p,g]=(0,a.useState)(!1),[x,j]=(0,a.useState)(0),[v,N]=(0,a.useState)(null),[b,w]=(0,a.useState)(!1),[k,y]=(0,a.useState)(!1),[S,$]=(0,a.useState)(t||1),[C,E]=(0,a.useState)(null),[I,T]=(0,a.useState)({}),O=(0,a.useRef)(!1),[A]=(0,a.useState)(new Audio("https://kpiece2.s3.eu-west-3.amazonaws.com/ost/tobecontinued.mp3"));(0,a.useEffect)((()=>{if(!h&&i.length>0){const e=i.length;parseInt(t)===e+1&&(A.volume=.05,A.currentTime=0,A.play().catch((e=>console.error("\xc9chec de la lecture audio :",e))))}}),[t,i,h,A]);const z=e=>new Promise((s=>{if(I[e.pageNum])return void s(!0);const t=new Image;t.src=e.url,t.onload=()=>{T((s=>({...s,[e.pageNum]:!0}))),s(!0)},t.onerror=()=>{T((s=>({...s,[e.pageNum]:!1}))),s(!1)}})),M=(0,a.useCallback)((async(e,s)=>{if(!e||0===e.length)return;g(!0);const t=parseInt(s)-1,a=[];t>=0&&t<e.length&&a.push(t);for(let c=1;c<=2;c++)t-c>=0&&a.push(t-c);for(let c=1;c<=5;c++)t+c<e.length&&a.push(t+c);const n=a.map((s=>e[s])),r=n.length;let o=0;for(const c of n)await z(c),o++,j(Math.floor(o/r*100));g(!1)}),[]),P=(0,a.useCallback)((async function(e,s){let t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5;if(!e||0===e.length||O.current)return;O.current=!0;const a=parseInt(s)-1+6,n=Math.min(a+t-1,e.length-1);if(a>n)return void(O.current=!1);const r=[];for(let u=a;u<=n;u++)I[e[u].pageNum]||r.push(e[u]);if(0===r.length)return void(O.current=!1);const o=Object.keys(I).length,c=e.length;j(Math.floor(o/c*100));const l=r.map((e=>z(e)));await Promise.all(l);const i=Object.keys(I).length;j(Math.floor(i/c*100)),O.current=!1}),[I]);(0,a.useEffect)((()=>{(async()=>{try{const a=await fetch(`https://kpiece2.s3.eu-west-3.amazonaws.com/data/tomes/${e}.json`);if(!a.ok)throw new Error("\xc9chec de la r\xe9cup\xe9ration des donn\xe9es du tome");const n=await a.json();n.sort(((e,s)=>e.tome-s.tome));const r=n.find((e=>e.tome===parseInt(s)));if(!r)throw new Error("Tome non trouv\xe9");const o=n.findIndex((e=>e.tome===parseInt(s))),c=o>0?n[o-1].tome:null,l=o<n.length-1?n[o+1].tome:null;E({...r,prevTome:c,nextTome:l});const i=await fetch("https://kpiece2.s3.eu-west-3.amazonaws.com/data/search.json");if(!i.ok)throw new Error("\xc9chec de la r\xe9cup\xe9ration des donn\xe9es de recherche");const d=await i.json(),h=Array.isArray(r.arc)?r.arc:[r.arc];let p=[];for(const e of h){const s=d.find((s=>s.arc===e));if(!s)continue;const t=Math.max(r.firstscan,s.firstscan),a=Math.min(r.lastscan,s.lastscan);for(let n=t;n<=a;n++)p.push({saga:s.saga,arc:e,scan:n})}if(0===p.length)throw new Error("Aucun scan trouv\xe9 pour ce tome");let g=[],x=[];for(const e of p){const{saga:s,arc:t,scan:a}=e,n=await fetch(`https://kpiece2.s3.eu-west-3.amazonaws.com/data/saga/${s}/${t}.json`);if(!n.ok){console.error(`\xc9chec de la r\xe9cup\xe9ration des donn\xe9es pour le scan ${a}`);continue}const r=(await n.json()).find((e=>e.scan===parseInt(a)));if(!r){console.error(`Scan ${a} non trouv\xe9 dans les donn\xe9es de l'arc`);continue}const o=r.maxpages,c=g.length+1;x.push({saga:s,arc:t,scan:a,name:r.name,startPage:c,endPage:c+o-1,maxpages:o});for(let e=1;e<=o;e++){const n=e<10?`0${e}`:e;g.push({pageNum:g.length+1,url:`https://kpiece2.s3.eu-west-3.amazonaws.com/scan/${s}/${t}/${a}/${n}.png`,scanIndex:x.length-1})}}u(g),m(x);const j=parseInt(t)||1;await M(g,j),f(!1)}catch(v){console.error("Erreur lors de la r\xe9cup\xe9ration des donn\xe9es :",v),N(v.message),f(!1)}})()}),[e,s,M]),(0,a.useEffect)((()=>{h||window.scrollTo(0,170)}),[t,h]),(0,a.useEffect)((()=>{$(t||1)}),[t]),(0,a.useEffect)((()=>{if(!h&&i.length>0&&t){const e=parseInt(t);P(i,e,5)}}),[t,h,i,P]);const F=()=>p?(0,c.jsxs)("div",{className:"loading-container",children:[(0,c.jsxs)("div",{className:"spinner",children:[(0,c.jsx)("div",{className:"double-bounce1"}),(0,c.jsx)("div",{className:"double-bounce2"})]}),(0,c.jsxs)("p",{children:["Chargement des pages : ",x,"%"]}),(0,c.jsx)("div",{className:"scan-loading-progress-bar",children:(0,c.jsx)("div",{className:"scan-loading-progress",style:{width:`${x}%`}})})]}):(0,c.jsx)(o.A,{});if(h)return(0,c.jsx)(F,{});if(v)return(0,c.jsx)("div",{className:"scan-page-error",children:"Tome Non disponible"});const R=i.length,B=t&&parseInt(t)<=R+1?parseInt(t):1,J=parseInt(t)===R+1;const L=B>R&&!J,V=(()=>{var e;return!B||B>R?null:d[null===(e=i[B-1])||void 0===e?void 0:e.scanIndex]})(),U=t=>{l(`/tomes/${e}/${s}/${t}`);const a=parseInt(t);if(a<=R){const e=a<R?a+1:null,s=a>1?a-1:null;e&&!I[e]&&z(i[e-1]),s&&!I[s]&&z(i[s-1])}},D=e=>{const s=e.currentTarget.getBoundingClientRect();if(e.clientX-s.left<s.width/2){if(1===B)return;U(B-1)}else U(B===R?R+1:B+1)},q=()=>{C&&C.prevTome&&l(`/tomes/${e}/${C.prevTome}/1`)},K=()=>{C&&C.nextTome&&l(`/tomes/${e}/${C.nextTome}/1`)},X=()=>U(R),Z=()=>{const e=parseInt(S,10);e>=1&&e<=R?U(e):$(B)};let G=null;if(b)G=i.map((e=>(0,c.jsx)("img",{src:e.url,alt:`Page ${e.pageNum}`,className:"scan-page-image",loading:"lazy"},e.pageNum)));else if(J)G=(0,c.jsxs)("div",{className:"last-page",children:[(0,c.jsx)("h2",{children:" TO BE CONTINUED... "}),(0,c.jsx)("div",{className:"bouton-last-page next-tome",children:(0,c.jsxs)("button",{onClick:K,children:[(0,c.jsx)("i",{className:"fa-solid fa-arrow-right"})," Tome suivant"]})}),(0,c.jsx)("div",{className:"bouton-last-page back-page",children:(0,c.jsxs)("button",{onClick:X,children:[(0,c.jsx)("i",{className:"fa-solid fa-arrow-left"})," RETOUR"]})}),(0,c.jsx)("div",{className:"bouton-last-page back-tome",children:(0,c.jsxs)("button",{onClick:q,children:[(0,c.jsx)("i",{className:"fa-solid fa-arrow-left"})," Tome pr\xe9c\xe9dent"]})})]});else if(L)G=(0,c.jsxs)("div",{className:"final-view",children:[(0,c.jsxs)("button",{onClick:q,children:[(0,c.jsx)("i",{className:"fa-solid fa-arrow-left"})," Tome pr\xe9c\xe9dent"]}),(0,c.jsxs)("button",{onClick:K,children:[(0,c.jsx)("i",{className:"fa-solid fa-arrow-right"})," Tome suivant"]}),(0,c.jsxs)("button",{onClick:X,children:[(0,c.jsx)("i",{className:"fa-solid fa-arrow-left"})," Revenir \xe0 la lecture"]})]});else{const e=i[B-1];G=(0,c.jsxs)("div",{className:"image-container",onClick:D,children:[(0,c.jsx)("div",{className:"left-half"}),(0,c.jsx)("div",{className:"right-half"}),(0,c.jsx)("img",{src:e.url,alt:`Page ${B}`,className:"scan-page-image"})]})}const H=Object.values(I).filter(Boolean).length,Q=R>0?Math.floor(H/R*100):0;return(0,c.jsxs)("div",{className:"scan-tome",children:[(0,c.jsxs)("div",{className:"top-scan-element",children:[(0,c.jsxs)("div",{className:"page-counter",children:["Page ",(0,c.jsx)("input",{type:"text",value:S,onChange:e=>{/^\d*$/.test(e.target.value)&&$(e.target.value)},onBlur:Z,onKeyDown:e=>{"Enter"===e.key&&Z()},style:{width:"50px",textAlign:"center"}})," / ",R]}),V&&(0,c.jsx)("div",{className:"select-scan",children:(0,c.jsxs)("select",{value:(null===V||void 0===V?void 0:V.scan)||"",onChange:e=>{const s=d.find((s=>s.scan.toString()===e.target.value));s&&U(s.startPage)},children:[(0,c.jsxs)("option",{value:"",disabled:!0,children:[" Tome ",s," - ",(null===C||void 0===C?void 0:C.name)||"Chargement..."," "]}),d.map(((e,s)=>(0,c.jsxs)("option",{value:e.scan,children:["Chapitre ",e.scan," - ",e.name]},s)))]})})]}),!J&&(0,c.jsx)(r.A,{onFullScreen:()=>{document.fullscreenElement?document.exitFullscreen&&(document.body.classList.remove("fullscreen-mode"),document.exitFullscreen(),y(!1)):document.documentElement.requestFullscreen().then((()=>{y(!0),document.body.classList.add("fullscreen-mode")})).catch((e=>console.error(`Erreur lors de l'activation du plein \xe9cran : ${e.message}`)))},onVerticalScan:()=>w((e=>!e)),isFullScreen:k}),G,R&&!J&&!b&&(0,c.jsx)("div",{className:"page-progress-bar",children:(0,c.jsx)("div",{className:"page-progress",style:{width:B/R*100+"%"}})}),Q<100&&(0,c.jsxs)("div",{className:"background-loading-indicator",style:{position:"fixed",bottom:"10px",right:"10px",background:"rgba(0, 0, 0, 0.3)",color:"white",padding:"5px 10px",borderRadius:"5px",fontSize:"10px",zIndex:1e3},children:["Pages charg\xe9es: ",H,"/",R," (",Q,"%)"]})]})}},809:(e,s,t)=>{t.d(s,{A:()=>o});var a=t(43),n=t(579);const r=()=>{var e;const[s,t]=(0,a.useState)({chill:[],danger:[],emotion:[],epic:[],fight:[],fun:[],mysterious:[],sad:[]}),[r,o]=(0,a.useState)((()=>{const e=localStorage.getItem("ostIsOn");return null!==e&&JSON.parse(e)})),[c,l]=(0,a.useState)((()=>{const e=localStorage.getItem("ostVolume");return null!==e?JSON.parse(e):50})),[i,u]=(0,a.useState)(""),[d,m]=(0,a.useState)(0),[h,f]=(0,a.useState)(!1),[p,g]=(0,a.useState)(!1),[x,j]=(0,a.useState)([]),v=(0,a.useRef)(null),N=async()=>{try{const e=await fetch("https://kpiece2.s3.eu-west-3.amazonaws.com/ost/ost.json");if(!e.ok)throw new Error("Failed to fetch OST info");const s=await e.json();return j(s),s}catch(e){return console.error("Error fetching OST info:",e),[]}},b=async function(e){let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;f(!0);const a=(s||x||await N()).find((s=>s.name===e));if(!a)return console.error(`Aucune info trouv\xe9e pour le mood: ${e}`),f(!1),[];const n=a.ostname.map(((e,s)=>({fileName:`${s+1}.mp3`,displayName:e})));return t((s=>({...s,[e]:n}))),f(!1),n},w=async(e,t)=>{r||o(!0),f(!0);let a=s[e];if(a&&0!==a.length||(a=await b(e)),a&&a.length>0){t>=a.length?t=0:t<0&&(t=a.length-1);const s=a[t],n=`https://kpiece2.s3.eu-west-3.amazonaws.com/ost/${e}/${s.fileName}`;v.current&&(v.current.pause(),v.current.src=n,v.current.volume=c/100,v.current.oncanplaythrough=()=>{v.current.play().then((()=>{u(e),m(t),g(!0),f(!1)})).catch((e=>{console.error("Erreur lors de la lecture:",e),g(!1),f(!1)}))},v.current.onerror=()=>{console.error(`Erreur de chargement pour: ${n}`),g(!1),f(!1)})}else console.error(`Aucune piste trouv\xe9e pour l'ambiance: ${e}`),g(!1),f(!1)};return(0,a.useEffect)((()=>{!r&&v.current&&(v.current.pause(),g(!1))}),[r]),(0,a.useEffect)((()=>{if(r){(async()=>{f(!0);const e=await N();for(const s of e)await b(s.name,e);f(!1)})()}else v.current&&(v.current.pause(),g(!1))}),[r]),(0,a.useEffect)((()=>{if(v.current){const e=()=>{i&&w(i,d+1)};return v.current.addEventListener("ended",e),()=>{v.current&&v.current.removeEventListener("ended",e)}}}),[i,d]),(0,a.useEffect)((()=>{localStorage.setItem("ostIsOn",JSON.stringify(r))}),[r]),(0,n.jsxs)("div",{className:"ost-player",children:[(0,n.jsx)("div",{className:"ost-title",children:"OST"}),(0,n.jsx)("div",{className:"switch-container",children:(0,n.jsxs)("label",{className:"switch",children:[(0,n.jsx)("input",{type:"checkbox",checked:r,onChange:()=>o(!r)}),(0,n.jsx)("span",{className:"slider round"})]})}),r&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("div",{className:"track-navigation",children:[(0,n.jsx)("button",{className:"prev-button",onClick:()=>{i&&w(i,d-1)},disabled:!i||h,children:(0,n.jsx)("i",{className:"fa-solid fa-backward-step"})}),(0,n.jsx)("button",{className:"play-pause-button",onClick:()=>{v.current&&(p?(v.current.pause(),g(!1)):v.current.src?v.current.play().then((()=>{g(!0)})).catch((e=>{console.error("Erreur lors de la reprise de lecture:",e)})):i&&w(i,d))},disabled:h||!i&&!(null!==(e=v.current)&&void 0!==e&&e.src),children:h?(0,n.jsx)("i",{className:"fa-solid fa-spinner fa-spin"}):p?(0,n.jsx)("i",{className:"fa-solid fa-pause"}):(0,n.jsx)("i",{className:"fa-solid fa-play"})}),(0,n.jsx)("button",{className:"next-button",onClick:()=>{i&&w(i,d+1)},disabled:!i||h,children:(0,n.jsx)("i",{className:"fa-solid fa-forward-step"})}),(0,n.jsx)("button",{className:"random-button",onClick:()=>{if(i&&s[i]&&s[i].length>0){let e;do{e=Math.floor(Math.random()*s[i].length)}while(e===d&&s[i].length>1);w(i,e)}},disabled:!i||h,children:(0,n.jsx)("i",{className:"fa-solid fa-shuffle"})})]}),(0,n.jsxs)("div",{className:"volume-container",children:[(0,n.jsx)("input",{type:"range",min:"0",max:"100",value:c,onChange:e=>{const s=e.target.value;l(s),localStorage.setItem("ostVolume",JSON.stringify(s)),v.current&&(v.current.volume=s/100)},className:"volume-slider"}),c,"%"]}),(0,n.jsx)("div",{className:"mood-buttons",children:Object.keys(s).map((e=>(0,n.jsx)("button",{className:`mood-button ${i===e?"active":""} ${h&&i!==e?"disabled":""}`,onClick:()=>(e=>{i!==e&&w(e,0)})(e),disabled:h&&i!==e,children:e.charAt(0).toUpperCase()+e.slice(1)},e)))}),(0,n.jsx)("div",{className:"current-audio",children:(0,n.jsxs)("p",{children:[" ",(0,n.jsx)("i",{className:"fa-solid fa-music"}),i&&s[i]&&s[i][d]?`  ${s[i][d].displayName}.mp3`:"Aucune Ost charg\xe9"]})}),(0,n.jsx)("audio",{ref:v})]})]})};const o=function(e){let{onFullScreen:s,onVerticalScan:t}=e;const[o,c]=a.useState(!0),l=o?{}:{position:"sticky",top:0,background:"black",borderRadius:0};return(0,n.jsxs)("div",{className:"scan-bar",style:l,children:[(0,n.jsx)("button",{onClick:s,className:"scan-bar-button",children:(0,n.jsx)("i",{className:"fa-solid fa-expand"})}),(0,n.jsx)("button",{onClick:()=>{c(!o),t&&t()},className:"scan-bar-button",children:(0,n.jsx)("i",{className:"fa-solid "+(o?"fa-arrows-up-down":"fa-arrows-left-right")})}),(0,n.jsx)(r,{})]})}}}]);
//# sourceMappingURL=727.9964ea4e.chunk.js.map